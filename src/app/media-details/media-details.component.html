<!-- Header with background image and overlay -->
<header>
  <div *ngIf="mediaDetails" class="header-img w-100 rounded-3 position-relative">
    <!-- Zoom animation when image becomes visible -->
    <img [@zoomIn]="overviewVisible ? 'visible' : 'void'"
         appAnimateOnVisible (visible)="overviewVisible = true"
         [src]="'https://image.tmdb.org/t/p/w1280' + mediaDetails.backdrop_path"
         class="w-100 h-100 rounded-3" alt="">
    <div class="overley position-absolute top-0 start-0 w-100 h-100"></div>
  </div>
</header>

<section>
  <div *ngIf="mediaDetails" class="position-relative overflow-hidden w-100 py-5">

    <!-- Button to toggle recommendation sidebar -->
    <div class="recommend-list p-3 position-absolute" (click)="onToggleRecommend()">
      <i class="fa-solid fa-bars fs-5"></i>
    </div>

    <!-- Media details section -->
    <div class="media-details position-relative">
      <div class="media-details-show px-2">

        <!-- Trailer or fallback image if trailer is not available -->
        <div class="video-show w-100 rounded-4">
          <ng-container *ngIf="trailerKey; else noTrailer">
            <!-- Embedded YouTube trailer -->
            <iframe width="100%" height="300"
                    [src]="trailerKey"
                    frameborder="0"
                    allow="autoplay; encrypted-media"
                    allowfullscreen></iframe>
          </ng-container>
          <ng-template #noTrailer>
            <!-- Display poster and fallback message -->
            <div class="text-center py-3">
              <img [@zoomIn]="overviewVisible ? 'visible' : 'void'"
                   appAnimateOnVisible (visible)="overviewVisible = true"
                   *ngIf="mediaDetails"
                   [src]="'https://image.tmdb.org/t/p/w500' + mediaDetails.poster_path"
                   alt="Poster" width="70%" height="300" class="rounded-4">
              <p class="pt-2">Trailer is not available for this media.</p>
            </div>
          </ng-template>

          <!-- Media stats: release date, views, buttons -->
          <div class="d-flex justify-content-lg-between gap-2 flex-wrap bg-black pt-2 px-2 border-bottom border-secondary">
            <p *ngIf="mediaDetails.release_date"><i class="fa-solid fa-clock"></i> {{mediaDetails.release_date | timeAgo}}</p>
            <p *ngIf="mediaDetails.first_air_date"><i class="fa-solid fa-clock"></i> {{mediaDetails.first_air_date | timeAgo}}</p>
            <p class="ps-lg-0 ps-2"><i class="fa-solid fa-eye"></i> {{mediaDetails.vote_count}} views</p>
            <div>
              <button class="px-2 py-1 text-white bg-dark"><i class="fa-solid fa-thumbs-up"></i> Like</button>
              <button class="px-2 py-1 ms-1 bg-dark text-white"><i class="fa-solid fa-thumbs-down"></i> Dislike</button>
            </div>
            <div>
              <button class="px-2 py-1 text-white bg-dark"><i class="fa-solid fa-share"></i> Share</button>
            </div>
          </div>
        </div>

        <!-- Overview and cast/crew -->
        <div class="details-show mt-2">
          <!-- Title -->
          <div class="pt-5 pb-1 border-bottom border-secondary">
            <h3 [@slideDown]="overviewVisible ? 'visible' : 'void'"
                appAnimateOnVisible (visible)="overviewVisible = true"
                *ngIf="mediaDetails.title">{{mediaDetails.title}}</h3>
            <h3 [@slideDown]="overviewVisible ? 'visible' : 'void'"
                appAnimateOnVisible (visible)="overviewVisible = true"
                *ngIf="mediaDetails.name">{{mediaDetails.name}}</h3>
          </div>

          <!-- Overview paragraph -->
          <div class="py-3 border-bottom border-secondary">
            <p [@slideUp]="overviewVisible ? 'visible' : 'void'"
               appAnimateOnVisible (visible)="overviewVisible = true">
              {{ showFullOverview ? mediaDetails.overview : (mediaDetails.overview) | seeMore:30 }}
            </p>

            <!-- Cast and crew if overview is fully shown -->
            <ng-container *ngIf="showFullOverview">
              <h4 class="pt-3">Cast</h4>
              <div class="d-flex justify-content-center gap-3 flex-wrap">
                <!-- Loop over cast members -->
                @for(castPerson of cast; track castPerson.id; let i = $index){
                  <div (click)="goToProfileDetails('person', castPerson.id)" style="cursor: pointer;"
                       *ngIf="castPerson.profile_path"
                       class="cast-person p-2 text-center overflow-hidden">
                    <img [@zoomIn]="visibleItems[i] ? 'visible' : 'void'"
                         appAnimateOnVisible (visible)="visibleItems[i] = true"
                         [src]="'https://image.tmdb.org/t/p/w500' + castPerson.profile_path"
                         [alt]="castPerson.name" width="100" height="100"
                         class="rounded-circle">
                    <p [@slideUp]="visibleItems[i] ? 'visible' : 'void'"
                       appAnimateOnVisible (visible)="visibleItems[i] = true"
                       class="pt-2">{{castPerson.name}}</p>
                  </div>
                }
              </div>
            </ng-container>

            <ng-container *ngIf="showFullOverview">
              <h4 class="pt-3">Crew</h4>
              <div class="d-flex justify-content-center gap-3 flex-wrap">
                <!-- Loop over crew members -->
                @for(crewPerson of crew; track crewPerson.id; let i = $index){
                  <div (click)="goToProfileDetails('person', crewPerson.id)" style="cursor: pointer;"
                       *ngIf="crewPerson.profile_path"
                       class="crew-person p-2 text-center overflow-hidden">
                    <img [@zoomIn]="visibleItems[i] ? 'visible' : 'void'"
                         appAnimateOnVisible (visible)="visibleItems[i] = true"
                         [src]="'https://image.tmdb.org/t/p/w500' + crewPerson.profile_path"
                         [alt]="crewPerson.name" width="100" height="100"
                         class="rounded-circle">
                    <p [@slideUp]="visibleItems[i] ? 'visible' : 'void'"
                         appAnimateOnVisible (visible)="visibleItems[i] = true" class="pt-2">
                      {{crewPerson.name}}
                    </p>
                  </div>
                }
              </div>
            </ng-container>

            <!-- Toggle overview visibility -->
            <a (click)="toggleOverview();" class="see-more-link">
              {{ showFullOverview ? 'See less' : 'See more' }}
            </a>
          </div>

          <!-- Production companies -->
          <div class="pt-4">
            <h5>Production companies</h5>
            <div class="d-flex justify-content-center flex-wrap gap-4 pt-4 border-bottom border-secondary">
              @for(company of mediaDetails.production_companies; track company.id; let i = $index){
                @if (company.logo_path) {
                  <div class="company-container text-center overflow-hidden">
                    <div class="rounded-3 bg-white">
                      <img [@zoomIn]="visibleItems[i] ? 'visible' : 'void'" 
                           appAnimateOnVisible (visible)="visibleItems[i] = true"
                           [src]="'https://image.tmdb.org/t/p/w500' + company.logo_path"
                           alt="{{company.name}} Logo">
                    </div>
                    <p [@slideUp]="visibleItems[i] ? 'visible' : 'void'"
                       appAnimateOnVisible (visible)="visibleItems[i] = true"
                       class="pt-2">{{company.name | seeMore:2}}</p>
                  </div>
                }
              }
            </div>
          </div>

          <!-- Comments section -->
          <div class="pt-5">
            <div class="comments-container rounded-3 p-xl-4 p-3 w-100 overflow-hidden">
              <h5 [@slideDown]="overviewVisible ? 'visible' : 'void'"
                  appAnimateOnVisible (visible)="overviewVisible = true"
                  class="fw-bold mb-3">Comments</h5>

              <!-- New comment input -->
              <div class="mb-3">
                <textarea class="form-control bg-black text-white border-0"
                          [(ngModel)]="newComment"
                          placeholder="Add a comment..." rows="3"></textarea>
                <div class="mt-2 d-flex justify-content-start gap-2">
                  <button class="btn btn-outline-light btn-sm" (click)="cancelComment()">Cancel</button>
                  <button class="button-mix-color text-white"
                          [disabled]="!newComment.trim()"
                          (click)="postComment()">Post Comment</button>
                </div>
              </div>

              <!-- Existing comments -->
              @for(review of reviewsList; track review.id; let i = $index){
                <div *ngIf="review.author_details.avatar_path"
                     class="bg-black mb-3 rounded-3 p-3">
                  <div class="d-flex justify-content-between">
                    <div>
                      <img  [@zoomIn]="visibleItems[i] ? 'visible' : 'void'"
                           appAnimateOnVisible (visible)="visibleItems[i] = true"
                           [src]="'https://image.tmdb.org/t/p/w500' + review.author_details.avatar_path"
                           class="rounded-circle me-2" width="50" height="50" alt="avatar" />
                      <span class="fw-semibold text-white ps-2">
                        &#64;{{review.author_details.username}}</span>
                      <span class="date-content ps-3">{{review.created_at | timeAgo}}</span>
                    </div>
                    <div class="pt-1">
                      <button class="px-2 py-1 bg-primary">Reply</button>
                    </div>
                  </div>
                  <div class="text-light small my-2">
                    {{ isFullShown(review.id) ? review.content : (review.content | seeMore:35) }}
                    <a *ngIf="isLongComment(review.content)"
                       (click)="toggleComment(review.id)" class="see-more-link">
                      {{ isFullShown(review.id) ? 'See less' : 'See more' }}
                    </a>
                  </div>
                </div>
              }
            </div>
          </div><!-- End of reviews -->
        </div>
      </div>

      <!-- Recommendations sidebar (if MoveRight is true) -->
      <div *ngIf="MoveRight" @slideOutIn class="recommendations rounded-3 p-3">
        @for(recommendation of mediaRecommendations; track recommendation.id; let i = $index){
          <div *ngIf=" recommendation.poster_path" class="w-100 d-flex p-2 mb-2 bg-black rounded-3 overflow-hidden">
            <img [@zoomIn]="visibleItems[i] ? 'visible' : 'void'"
                 appAnimateOnVisible (visible)="visibleItems[i] = true"
                 (click)="[goToMediaDetails(type, recommendation.id), onToggleRecommend()]"
                 [src]="'https://image.tmdb.org/t/p/w500' + recommendation.poster_path"
                 height="100"
                 class="rounded-3" alt="">
            <div class="ps-2">
              <p *ngIf="recommendation.title"
                 [@slideDown]="visibleItems[i] ? 'visible' : 'void'"
                 appAnimateOnVisible (visible)="visibleItems[i] = true"
                 (click)="[goToMediaDetails(type, recommendation.id), onToggleRecommend()]"
                 class="media-title">
                {{recommendation.title | seeMore:4}}
              </p>
              <p *ngIf="recommendation.name"
                 [@slideDown]="visibleItems[i] ? 'visible' : 'void'"
                 appAnimateOnVisible (visible)="visibleItems[i] = true"
                 (click)="[goToMediaDetails(type, recommendation.id), onToggleRecommend()]"
                 class="media-title">
                {{recommendation.name | seeMore:4}}
              </p>
              <span *ngIf="recommendation.release_date">
                <i class="fa-solid fa-clock"></i> {{recommendation.release_date | timeAgo}}
              </span>
              <span *ngIf="recommendation.first_air_date">
                <i class="fa-solid fa-clock"></i> {{recommendation.first_air_date | timeAgo}}
              </span><br>
              <span><i class="fa-solid fa-eye"></i> {{recommendation.vote_count}} views</span>
            </div>
          </div>
        }
      </div>

    </div>
  </div>
</section>
